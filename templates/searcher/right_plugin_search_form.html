
{% load i18n %}
{% load common_filters %}

{% comment %}
<!--
  Copyright (C) 2013 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% comment %}
<!--
For Content-based Search functionality, 
Murphy Lab. @CMU modified the original template file.
Those parts that have been modified are noted as "by CMU"

The latest modified Date: Dec., 2011
Authors: Baek Hwan Cho and Robert F. Murphy @CMU
-->
{% endcomment %}

<script type="text/javascript">

    $(function(){
        $("input[name=search_against]").click(function(){
            var searchDataset = ($(this).val() === "dataset"),
                $dataset_ID = $("select[name=dataset_ID]");
            if (searchDataset) {
                $dataset_ID.removeAttr('disabled')
                    .focus();
            } else {
                $dataset_ID.attr('disabled', 'true');
            }
        });

        $(".cztEdit").click(function() {
            $(".cztSelects", $(this).parent()).toggle();
        });

        $(".cztSelects select").change(function(){
            var $this = $(this),
                $td = $this.parent().parent(),
                $input = $("input", $td),    // form submission
                $span = $("span", $td),      // display
                idxs = [];
            $('select', $this.parent()).each(function(){
                idxs.push( $(this).val() );
            });
            var czt = idxs.join(".");
            $input.val(czt);
            $span.text(czt);
        });


        $('input.search_filter_item').change(function() {
            var all_checked = true;
            var parent = $(this).parent().parent()
            parent.children().children('input.search_filter_item').each(function() {
                all_checked = all_checked && this.checked;
            });
            parent.find('input.search_filter_all').prop('checked', all_checked);
        });

        $('input.search_filter_all').change(function() {
            var all_checked = this.checked;
            $(this).parent().children().children('input.search_filter_item')
                .each(function() {
                    this.checked = all_checked;
                });
        });


        $(".search_filter_toggle").click(function(event){
            event.preventDefault();
            $(this).next().slideToggle(500, function(){
                $(this).prev().text($(this).is(':visible')?
                    '[\u2013] hide' : '[+] show');
            })
        });

        // Hide by default
        $(".search_filter_toggle").next().hide(0, function(){
            $(this).prev().text('[+] show');
        });

    });    

</script>

<style type="text/css">
    .content_search>div {
        padding:4px 0px;
    }
    .content_search td {
        vertical-align:middle;
    }
    .cztEdit:hover {
        text-decoration: underline;
        cursor: pointer;
    }
    .cztSelects {
        white-space: nowrap;
        position: absolute;
        top: 10px;
    }

</style>

<div id="content_details" class="right_tab_inner">

    <h1>Image Content Search</h1>

    <form class="content_search" method="POST" action="{% url searchpage %}">
        <div>
            <label for="featureset_Name">Featureset Name:</label>
            <select id="featureset" name="featureset_Name">
                <option value="slf33">slf33</option>
                <option value="slf34">slf34</option>
            </select>
        </div>

        <div>
            <label for="NumRetrieve">Retrieved images:</label>
            <select name="NumRetrieve">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="100" selected="true">100</option>
                <option value="500">500</option>
            </select>
        </div>

        <div>
            <label for="search_against">Search Against:</label>
            <div style="margin-left:20px">
                <div style="float:left">
                    Entire Database<input type="radio" checked='true' name="search_against" value="db"/>
                </div>
                <div style="float:left">
                    Dataset<input type="radio" name="search_against" value="dataset"/><br/>
                    <select name="dataset_ID" disabled="true">
                        {% for d in datasets %}
                            <option value="{{ d.getId }}">
                                {{ d.getName }}
                                {% if d.countChildren %} [{{ d.countChildren }}] {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div style="clear:both"></div>
            </div>
        </div>

        <div id="search_filter_users">
            <label for="limit_users">Filter by users:</label>
            <a href="#" title="Show/Hide" class="search_filter_toggle"></a>
            <div style="margin-left:20px">
                <input type="checkbox" checked="true" name="limit_users_all"
                    class="search_filter_all" value="All">All</input>

                {% for userid, username in users.items %}
                <div style="margin-left:20px">
                    <input type="checkbox" checked="checked"
                        class="search_filter_item"
                        name="limit_users" value="{{userid}}"
                        >{{ username }}</input>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="search_filter_datasets">
            <label for="limit_datasets">Filter by Project/Dataset:</label>
            <a href="#" title="Show/Hide" class="search_filter_toggle"></a>
            <div style="margin-left:20px">

                {% for projectid, projectdata in projects.items %}
                <div>
                    <input type="checkbox" checked="checked"
                        class="search_filter_all" name="project"
                        value="{{projectdata.0}}">{{projectdata.0}}</input>

                    {% for dsid, dsname in projectdata.1.items %}
                    <div style="margin-left:20px">
                        <input type="checkbox" checked="checked"
                            class="search_filter_item" name="limit_datasets"
                            value="{{dsid}}">{{ dsname }}</input>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}

            </div>
        </div>

        <input style="float:right" type="submit" value="Do Search"/> 

        <div style="clear:both"></div>
        <hr style="margin-top:0px" />

        <table>
            <thead> 
                <tr> 
                    <th width="10%">{% trans "Image" %}</th>
                    <th width="10%">C.Z.T</th>
                    <th width="30%">{% trans "Name" %}</th>
                    <th width="10%">{% trans "Negative" %}</th>
                    <th width="10%">{% trans "Positive" %}</th>
                </tr> 
            </thead>
            <tbody>
                {% for c in images %}
                    <tr>
                        <td class="action">
                            <img src="{% url render_thumbnail_resize 32 c.id  %}" alt="image" title="{{c.id}}"/>
                            <input name="allIds" style="display:none" value="{{c.superid}}" type="text" />

                        </td>
                        <td>
                            <div style="position:relative">
                                {# with defZ=c.getDefaultZ defT=c.getDefaultT #}
                                {% with defC=c.defC defZ=c.defZ defT=c.defT %}
                                <span class="cztEdit" title="Edit Channel/Z/T">{{ defC }}.{{ defZ }}.{{ defT }}</span>
                                <div class="cztSelects" style="display:none">
                                    <select name="selected_c-{{ c.superid }}" title="Choose C index">
                                        {% for i in c.im.getSizeC|get_range %}
                                            <option value="{{ i }}" {% ifequal i defC %}selected='true'{% endifequal %}>
                                                {{ i }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <select name="selected_z-{{ c.superid }}" title="Choose Z index">
                                        {% for i in c.im.getSizeZ|get_range %}
                                            <option value="{{ i }}" {% ifequal i defZ %}selected='true'{% endifequal %}>
                                                {{ i }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <select name="selected_t-{{ c.superid }}" title="Choose T index">
                                        {% for i in c.im.getSizeT|get_range %}
                                            <option value="{{ i }}" {% ifequal i defT %}selected='true'{% endifequal %}>
                                                {{ i }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% endwith %}
                            </div>
                        </td>
                        <td>{{ c.im.name }}</td>
                        <td align="center">
                            <input type="radio" name="posNeg-{{ c.superid }}" value="neg">
                        </td> 
                        <td align="center">
                            <input type="radio" name="posNeg-{{ c.superid }}" value="pos" checked="true">
                        </td> 
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>    
